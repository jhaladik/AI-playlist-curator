<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Playlist Curator - Enhanced Testing Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        input, textarea, button, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav button {
            width: auto;
            padding: 8px 16px;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            font-size: 12px;
        }
        
        .nav button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            display: none;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .playlist-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }
        
        .playlist-meta {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .user-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .api-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .jwt-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        .jwt-payload {
            background: #e8f4f8;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }

        .countdown {
            font-weight: bold;
            color: #dc3545;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .test-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }

        .test-card h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        .debug-panel {
            background: #f1f3f4;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .debug-info {
            font-family: monospace;
            font-size: 12px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #4285f4;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .button-group button {
            width: auto;
            padding: 8px 16px;
            font-size: 12px;
        }

        .small-button {
            width: auto !important;
            padding: 6px 12px !important;
            font-size: 11px !important;
            margin: 2px !important;
        }

        .endpoint-test {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fafafa;
        }

        .endpoint-test h5 {
            margin-bottom: 8px;
            color: #333;
        }

        .method-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 8px;
        }

        .method-get { background: #28a745; color: white; }
        .method-post { background: #007bff; color: white; }
        .method-put { background: #ffc107; color: black; }
        .method-delete { background: #dc3545; color: white; }

        .response-time {
            font-size: 11px;
            color: #666;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status disconnected">🔴 Disconnected</div>
    
    <div class="container">
        <div class="header">
            <h1>🎵 AI Playlist Curator - Enhanced Testing Suite</h1>
            <p>Phase 1: Authentication & Core Infrastructure Testing</p>
        </div>
        
        <div class="content">
            <!-- API Status -->
            <div class="api-info">
                <strong>🔧 Testing Mode:</strong> Make sure you're running <code>wrangler dev</code> in your terminal first!
                <br><strong>API URL:</strong> <span id="apiUrl">http://localhost:8787</span>
                <br><strong>JWT Secret Status:</strong> <span id="jwtStatus">Checking...</span>
            </div>
            
            <!-- Navigation -->
            <div class="nav">
                <button onclick="showSection('auth')" class="active" id="authBtn">Authentication</button>
                <button onclick="showSection('jwt')" id="jwtBtn">JWT Testing</button>
                <button onclick="showSection('endpoints')" id="endpointsBtn">API Testing</button>
                <button onclick="showSection('playlists')" id="playlistsBtn">Playlists</button>
                <button onclick="showSection('profile')" id="profileBtn">Profile</button>
                <button onclick="showSection('debug')" id="debugBtn">Debug</button>
                <button onclick="testConnection()" style="background: #28a745;">🔌 Test API</button>
                <button onclick="runAllTests()" style="background: #fd7e14;">🧪 Run All Tests</button>
            </div>
            
            <!-- Status Messages -->
            <div id="status" class="status"></div>
            
            <!-- Authentication Section -->
            <div id="auth" class="section active">
                <h2>Authentication Testing</h2>
                
                <div class="test-grid">
                    <div class="test-card">
                        <h4>Register New User</h4>
                        <form id="registerForm">
                            <div class="form-group">
                                <label>Email:</label>
                                <input type="email" id="regEmail" required placeholder="test@example.com">
                            </div>
                            <div class="form-group">
                                <label>Password:</label>
                                <input type="password" id="regPassword" required placeholder="Test123!">
                                <small>8+ chars with uppercase, lowercase, and number</small>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="gdprConsent" required>
                                    <label for="gdprConsent">I consent to data processing (GDPR)</label>
                                </div>
                            </div>
                            <button type="submit">Register</button>
                        </form>
                    </div>
                    
                    <div class="test-card">
                        <h4>Login Existing User</h4>
                        <form id="loginForm">
                            <div class="form-group">
                                <label>Email:</label>
                                <input type="email" id="loginEmail" required placeholder="test@example.com">
                            </div>
                            <div class="form-group">
                                <label>Password:</label>
                                <input type="password" id="loginPassword" required placeholder="Test123!">
                            </div>
                            <button type="submit">Login</button>
                        </form>
                    </div>
                </div>
                
                <div class="button-group" style="margin-top: 20px;">
                    <button onclick="logout()" id="logoutBtn" style="background: #dc3545;">Logout</button>
                    <button onclick="generateTestUser()" style="background: #6f42c1;">Generate Test User</button>
                    <button onclick="testPasswordValidation()" style="background: #e83e8c;">Test Password Validation</button>
                    <button onclick="testEmailValidation()" style="background: #20c997;">Test Email Validation</button>
                </div>
            </div>
            
            <!-- JWT Testing Section -->
            <div id="jwt" class="section">
                <h2>JWT Token Testing</h2>
                
                <div id="jwtInfo" class="user-info">
                    <h3>Current JWT Token</h3>
                    <p><strong>Status:</strong> <span id="tokenStatus">No token</span></p>
                    <p><strong>Expires in:</strong> <span id="tokenCountdown">N/A</span></p>
                </div>
                
                <div class="jwt-display" id="jwtDisplay">
                    No JWT token available
                </div>
                
                <div class="button-group">
                    <button onclick="decodeCurrentJWT()" class="small-button">Decode Current JWT</button>
                    <button onclick="validateJWTSignature()" class="small-button">Validate Signature</button>
                    <button onclick="testExpiredToken()" class="small-button">Test Expired Token</button>
                    <button onclick="testInvalidToken()" class="small-button">Test Invalid Token</button>
                    <button onclick="refreshToken()" class="small-button">Refresh Token</button>
                    <button onclick="clearToken()" class="small-button" style="background: #dc3545;">Clear Token</button>
                </div>
                
                <div class="debug-panel">
                    <h4>JWT Debug Information</h4>
                    <div id="jwtDebugInfo" class="debug-info">
                        JWT debug information will appear here...
                    </div>
                </div>
            </div>
            
            <!-- API Endpoints Testing -->
            <div id="endpoints" class="section">
                <h2>API Endpoints Testing</h2>
                
                <div class="endpoint-test">
                    <h5><span class="method-badge method-get">GET</span>/api/health <span class="response-time" id="health-time"></span></h5>
                    <button onclick="testEndpoint('/api/health', 'GET')" class="small-button">Test Health Check</button>
                </div>
                
                <div class="endpoint-test">
                    <h5><span class="method-badge method-post">POST</span>/api/auth/register <span class="response-time" id="register-time"></span></h5>
                    <button onclick="testRegisterEndpoint()" class="small-button">Test Registration</button>
                </div>
                
                <div class="endpoint-test">
                    <h5><span class="method-badge method-post">POST</span>/api/auth/login <span class="response-time" id="login-time"></span></h5>
                    <button onclick="testLoginEndpoint()" class="small-button">Test Login</button>
                </div>
                
                <div class="endpoint-test">
                    <h5><span class="method-badge method-get">GET</span>/api/auth/profile <span class="response-time" id="profile-time"></span></h5>
                    <button onclick="testEndpoint('/api/auth/profile', 'GET', true)" class="small-button">Test Profile (Auth Required)</button>
                </div>
                
                <div class="endpoint-test">
                    <h5><span class="method-badge method-get">GET</span>/api/playlists <span class="response-time" id="playlists-time"></span></h5>
                    <button onclick="testEndpoint('/api/playlists', 'GET', true)" class="small-button">Test Get Playlists</button>
                </div>
                
                <div class="endpoint-test">
                    <h5><span class="method-badge method-post">POST</span>/api/playlists <span class="response-time" id="create-playlist-time"></span></h5>
                    <button onclick="testCreatePlaylistEndpoint()" class="small-button">Test Create Playlist</button>
                </div>
                
                <div class="endpoint-test">
                    <h5><span class="method-badge method-get">GET</span>/api/stats <span class="response-time" id="stats-time"></span></h5>
                    <button onclick="testEndpoint('/api/stats', 'GET', true)" class="small-button">Test Stats</button>
                </div>
                
                <div class="button-group">
                    <button onclick="testAllEndpoints()" style="background: #fd7e14;">Test All Endpoints</button>
                    <button onclick="testCORS()" style="background: #6610f2;">Test CORS</button>
                    <button onclick="testRateLimiting()" style="background: #e83e8c;">Test Rate Limiting</button>
                </div>
            </div>
            
            <!-- Playlists Section -->
            <div id="playlists" class="section">
                <h2>Playlist Management</h2>
                
                <div style="margin-bottom: 20px;">
                    <h3>Create New Playlist</h3>
                    <form id="createPlaylistForm">
                        <div class="form-group">
                            <label>Title:</label>
                            <input type="text" id="playlistTitle" required maxlength="200" placeholder="My Awesome Playlist">
                        </div>
                        <div class="form-group">
                            <label>Description:</label>
                            <textarea id="playlistDescription" rows="3" placeholder="A collection of amazing videos about..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>YouTube Playlist ID (optional):</label>
                            <input type="text" id="youtubeId" placeholder="PLxxxxxxxxxxxxx">
                        </div>
                        <button type="submit">Create Playlist</button>
                    </form>
                </div>
                
                <div class="button-group">
                    <button onclick="loadPlaylists()">🔄 Refresh Playlists</button>
                    <button onclick="createTestPlaylists()" style="background: #6f42c1;">Generate Test Playlists</button>
                    <button onclick="deleteAllPlaylists()" style="background: #dc3545;">Delete All Playlists</button>
                </div>
                
                <div>
                    <h3>Your Playlists</h3>
                    <div id="playlistList"></div>
                </div>
            </div>
            
            <!-- Profile Section -->
            <div id="profile" class="section">
                <h2>User Profile & Statistics</h2>
                <div id="userInfo"></div>
                <div id="userStats"></div>
                
                <div class="button-group">
                    <button onclick="loadProfile()">🔄 Refresh Profile</button>
                    <button onclick="testGDPRCompliance()">Test GDPR Compliance</button>
                    <button onclick="exportUserData()">Export User Data</button>
                </div>
            </div>
            
            <!-- Debug Section -->
            <div id="debug" class="section">
                <h2>Debug & System Information</h2>
                
                <div class="debug-panel">
                    <h4>System Status</h4>
                    <div class="button-group">
                        <button onclick="checkDatabaseHealth()" class="small-button">Check Database</button>
                        <button onclick="checkKVHealth()" class="small-button">Check KV Store</button>
                        <button onclick="testEnvironmentVars()" class="small-button">Test Environment</button>
                        <button onclick="viewServerLogs()" class="small-button">View Logs</button>
                    </div>
                    <div id="systemStatus" class="debug-info">
                        System status information will appear here...
                    </div>
                </div>
                
                <div class="debug-panel">
                    <h4>Request/Response Monitor</h4>
                    <div class="button-group">
                        <button onclick="startRequestMonitoring()" class="small-button">Start Monitoring</button>
                        <button onclick="stopRequestMonitoring()" class="small-button">Stop Monitoring</button>
                        <button onclick="clearRequestLog()" class="small-button">Clear Log</button>
                    </div>
                    <div id="requestLog" class="debug-info">
                        Request monitoring stopped. Click "Start Monitoring" to begin.
                    </div>
                </div>
                
                <div class="debug-panel">
                    <h4>Performance Metrics</h4>
                    <div id="performanceMetrics" class="debug-info">
                        Performance metrics will appear here...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8787';
        let authToken = localStorage.getItem('authToken');
        let requestMonitoring = false;
        let requestLog = [];
        let performanceMetrics = {
            requests: 0,
            totalTime: 0,
            averageTime: 0,
            errors: 0
        };
        
        // Update API URL display
        document.getElementById('apiUrl').textContent = API_BASE;
        
        // JWT Token Countdown
        let countdownInterval = null;
        
        function startTokenCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            
            if (!authToken) {
                document.getElementById('tokenCountdown').textContent = 'N/A';
                return;
            }
            
            try {
                const payload = JSON.parse(atob(authToken.split('.')[1]));
                const exp = payload.exp * 1000; // Convert to milliseconds
                
                countdownInterval = setInterval(() => {
                    const now = Date.now();
                    const timeLeft = exp - now;
                    
                    if (timeLeft <= 0) {
                        document.getElementById('tokenCountdown').textContent = 'EXPIRED';
                        document.getElementById('tokenStatus').textContent = 'Expired';
                        clearInterval(countdownInterval);
                    } else {
                        const minutes = Math.floor(timeLeft / 60000);
                        const seconds = Math.floor((timeLeft % 60000) / 1000);
                        document.getElementById('tokenCountdown').textContent = `${minutes}m ${seconds}s`;
                    }
                }, 1000);
            } catch (error) {
                document.getElementById('tokenCountdown').textContent = 'Invalid token';
            }
        }
        
        // Connection status checker
        async function testConnection() {
            const startTime = performance.now();
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                
                if (data.status === 'healthy') {
                    updateConnectionStatus(true);
                    showStatus(`✅ API connection successful! (${responseTime}ms)`, 'success');
                    document.getElementById('jwtStatus').textContent = 'Connected - JWT endpoint available';
                    document.getElementById('health-time').textContent = `${responseTime}ms`;
                } else {
                    updateConnectionStatus(false);
                    showStatus('❌ API returned unexpected response', 'error');
                }
            } catch (error) {
                updateConnectionStatus(false);
                showStatus(`❌ Connection failed: ${error.message}. Make sure 'wrangler dev' is running!`, 'error');
                document.getElementById('jwtStatus').textContent = 'Disconnected - Cannot test JWT';
            }
        }
        
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'connection-status connected';
                status.textContent = '🟢 Connected';
            } else {
                status.className = 'connection-status disconnected';
                status.textContent = '🔴 Disconnected';
            }
        }
        
        // Utility functions
        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            setTimeout(() => status.style.display = 'none', 8000);
        }
        
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(sectionName).classList.add('active');
            document.getElementById(sectionName + 'Btn').classList.add('active');
            
            if (sectionName === 'playlists') loadPlaylists();
            if (sectionName === 'profile') loadProfile();
            if (sectionName === 'jwt') updateJWTDisplay();
            if (sectionName === 'debug') updateSystemStatus();
        }
        
        function logRequest(method, url, status, responseTime, error = null) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                method,
                url,
                status,
                responseTime,
                error
            };
            
            requestLog.push(logEntry);
            
            // Keep only last 100 requests
            if (requestLog.length > 100) {
                requestLog = requestLog.slice(-100);
            }
            
            // Update performance metrics
            performanceMetrics.requests++;
            performanceMetrics.totalTime += responseTime;
            performanceMetrics.averageTime = Math.round(performanceMetrics.totalTime / performanceMetrics.requests);
            if (error) performanceMetrics.errors++;
            
            // Update display if monitoring is active
            if (requestMonitoring) {
                updateRequestLog();
                updatePerformanceMetrics();
            }
        }
        
        async function apiCall(endpoint, options = {}) {
            const startTime = performance.now();
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (authToken) {
                headers.Authorization = `Bearer ${authToken}`;
            }
            
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers
                });
                
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                
                logRequest(options.method || 'GET', endpoint, response.status, responseTime);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Network error' }));
                    const error = new Error(errorData.error || `HTTP ${response.status}`);
                    logRequest(options.method || 'GET', endpoint, response.status, responseTime, error.message);
                    throw error;
                }
                
                return await response.json();
            } catch (error) {
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                logRequest(options.method || 'GET', endpoint, 0, responseTime, error.message);
                console.error('API call error:', error);
                throw error;
            }
        }
        
        // JWT Testing Functions
        function decodeCurrentJWT() {
            if (!authToken) {
                showStatus('❌ No JWT token available', 'error');
                return;
            }
            
            try {
                const parts = authToken.split('.');
                const header = JSON.parse(atob(parts[0]));
                const payload = JSON.parse(atob(parts[1]));
                
                const jwtInfo = {
                    header,
                    payload,
                    signature: parts[2],
                    isExpired: payload.exp * 1000 < Date.now(),
                    expiresAt: new Date(payload.exp * 1000).toLocaleString(),
                    issuedAt: new Date(payload.iat * 1000).toLocaleString()
                };
                
                document.getElementById('jwtDebugInfo').textContent = JSON.stringify(jwtInfo, null, 2);
                showStatus('✅ JWT decoded successfully', 'success');
                
            } catch (error) {
                showStatus(`❌ Failed to decode JWT: ${error.message}`, 'error');
            }
        }
        
        function updateJWTDisplay() {
            const display = document.getElementById('jwtDisplay');
            const status = document.getElementById('tokenStatus');
            
            if (!authToken) {
                display.textContent = 'No JWT token available';
                status.textContent = 'No token';
                return;
            }
            
            try {
                const parts = authToken.split('.');
                const payload = JSON.parse(atob(parts[1]));
                const isExpired = payload.exp * 1000 < Date.now();
                
                display.innerHTML = `
                    <strong>Token:</strong> ${authToken.substring(0, 50)}...
                    <div class="jwt-payload">
                        <strong>Payload:</strong><br>
                        ${JSON.stringify(payload, null, 2)}
                    </div>
                `;
                
                status.textContent = isExpired ? 'Expired' : 'Valid';
                startTokenCountdown();
                
            } catch (error) {
                display.textContent = 'Invalid JWT token format';
                status.textContent = 'Invalid';
            }
        }
        
        async function validateJWTSignature() {
            if (!authToken) {
                showStatus('❌ No JWT token to validate', 'error');
                return;
            }
            
            try {
                const data = await apiCall('/api/auth/profile');
                showStatus('✅ JWT signature is valid', 'success');
            } catch (error) {
                showStatus(`❌ JWT validation failed: ${error.message}`, 'error');
            }
        }
        
        function testExpiredToken() {
            // Create a token that's already expired
            const expiredToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJ0ZXN0IiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIiwiaWF0IjoxNjAwMDAwMDAwLCJleHAiOjE2MDAwMDAwMDF9.invalid';
            
            const oldToken = authToken;
            authToken = expiredToken;
            localStorage.setItem('authToken', expiredToken);
            
            apiCall('/api/auth/profile').then(() => {
                showStatus('❌ Expired token was accepted (this is a security issue!)', 'error');
            }).catch((error) => {
                showStatus('✅ Expired token correctly rejected', 'success');
                // Restore old token
                authToken = oldToken;
                if (oldToken) {
                    localStorage.setItem('authToken', oldToken);
                } else {
                    localStorage.removeItem('authToken');
                }
            });
        }
        
        function testInvalidToken() {
            const invalidToken = 'invalid.token.here';
            const oldToken = authToken;
            authToken = invalidToken;
            localStorage.setItem('authToken', invalidToken);
            
            apiCall('/api/auth/profile').then(() => {
                showStatus('❌ Invalid token was accepted (this is a security issue!)', 'error');
            }).catch((error) => {
                showStatus('✅ Invalid token correctly rejected', 'success');
                // Restore old token
                authToken = oldToken;
                if (oldToken) {
                    localStorage.setItem('authToken', oldToken);
                } else {
                    localStorage.removeItem('authToken');
                }
            });
        }
        
        async function refreshToken() {
            if (!authToken) {
                showStatus('❌ No token to refresh', 'error');
                return;
            }
            
            try {
                // In a real app, you'd have a refresh endpoint
                // For now, we'll just re-login
                showStatus('ℹ️ Token refresh not implemented yet. Please re-login.', 'info');
            } catch (error) {
                showStatus(`❌ Token refresh failed: ${error.message}`, 'error');
            }
        }
        
        function clearToken() {
            authToken = null;
            localStorage.removeItem('authToken');
            updateJWTDisplay();
            showStatus('🗑️ JWT token cleared', 'info');
        }
        
        // Endpoint Testing Functions
        async function testEndpoint(endpoint, method = 'GET', requireAuth = false, body = null) {
            const elementId = endpoint.replace(/\//g, '-').replace(/^-/, '') + '-time';
            const timeElement = document.getElementById(elementId);
            
            if (requireAuth && !authToken) {
                showStatus(`❌ ${method} ${endpoint}: Authentication required`, 'error');
                return;
            }
            
            try {
                const options = { method };
                if (body) options.body = JSON.stringify(body);
                
                const startTime = performance.now();
                const data = await apiCall(endpoint, options);
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                
                if (timeElement) timeElement.textContent = `${responseTime}ms`;
                
                showStatus(`✅ ${method} ${endpoint}: Success (${responseTime}ms)\n${JSON.stringify(data, null, 2)}`, 'success');
                
            } catch (error) {
                if (timeElement) timeElement.textContent = 'Error';
                showStatus(`❌ ${method} ${endpoint}: ${error.message}`, 'error');
            }
        }
        
        async function testRegisterEndpoint() {
            const email = `test-${Date.now()}@example.com`;
            const body = {
                email,
                password: 'Test123!',
                gdprConsent: true
            };
            
            await testEndpoint('/api/auth/register', 'POST', false, body);
        }
        
        async function testLoginEndpoint() {
            const body = {
                email: 'test@example.com',
                password: 'Test123!'
            };
            
            await testEndpoint('/api/auth/login', 'POST', false, body);
        }
        
        async function testCreatePlaylistEndpoint() {
            const body = {
                title: `Test Playlist ${Date.now()}`,
                originalDescription: 'Auto-generated test playlist',
                youtubeId: null
            };
            
            await testEndpoint('/api/playlists', 'POST', true, body);
        }
        
        async function testAllEndpoints() {
            showStatus('🧪 Running comprehensive endpoint tests...', 'info');
            
            const tests = [
                () => testEndpoint('/api/health', 'GET'),
                () => testEndpoint('/api/auth/profile', 'GET', true),
                () => testEndpoint('/api/playlists', 'GET', true),
                () => testEndpoint('/api/stats', 'GET', true),
            ];
            
            for (const test of tests) {
                try {
                    await test();
                    await new Promise(resolve => setTimeout(resolve, 500)); // Delay between tests
                } catch (error) {
                    console.error('Test failed:', error);
                }
            }
            
            showStatus('✅ All endpoint tests completed', 'success');
        }
        
        async function testCORS() {
            try {
                const response = await fetch(`${API_BASE}/api/health`, {
                    method: 'OPTIONS'
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };
                
                showStatus(`✅ CORS Headers:\n${JSON.stringify(corsHeaders, null, 2)}`, 'success');
                
            } catch (error) {
                showStatus(`❌ CORS test failed: ${error.message}`, 'error');
            }
        }
        
        async function testRateLimiting() {
            showStatus('🔄 Testing rate limiting (sending 10 rapid requests)...', 'info');
            
            const promises = [];
            for (let i = 0; i < 10; i++) {
                promises.push(apiCall('/api/health'));
            }
            
            try {
                const results = await Promise.allSettled(promises);
                const successful = results.filter(r => r.status === 'fulfilled').length;
                const failed = results.filter(r => r.status === 'rejected').length;
                
                showStatus(`✅ Rate limiting test: ${successful} successful, ${failed} failed requests`, 'success');
                
            } catch (error) {
                showStatus(`❌ Rate limiting test failed: ${error.message}`, 'error');
            }
        }
        
        // Test Data Generation
        function generateTestUser() {
            const timestamp = Date.now();
            document.getElementById('regEmail').value = `test-${timestamp}@example.com`;
            document.getElementById('regPassword').value = 'Test123!';
            document.getElementById('gdprConsent').checked = true;
            
            document.getElementById('loginEmail').value = `test-${timestamp}@example.com`;
            document.getElementById('loginPassword').value = 'Test123!';
            
            showStatus('✅ Test user credentials generated', 'success');
        }
        
        async function createTestPlaylists() {
            if (!authToken) {
                showStatus('❌ Please log in first', 'error');
                return;
            }
            
            const testPlaylists = [
                { title: 'Climate Change Deep Dive', description: 'Educational content about climate science' },
                { title: 'AI Ethics & Society', description: 'Exploring the ethical implications of AI' },
                { title: 'Space Exploration 2024', description: 'Latest in space technology and exploration' },
                { title: 'Renewable Energy Innovations', description: 'Cutting-edge clean energy solutions' },
                { title: 'Quantum Computing Basics', description: 'Introduction to quantum computing concepts' }
            ];
            
            for (const playlist of testPlaylists) {
                try {
                    await apiCall('/api/playlists', {
                        method: 'POST',
                        body: JSON.stringify({
                            title: playlist.title,
                            originalDescription: playlist.description
                        })
                    });
                } catch (error) {
                    console.error('Failed to create test playlist:', error);
                }
            }
            
            showStatus('✅ Test playlists created', 'success');
            loadPlaylists();
        }
        
        // Validation Testing
        function testPasswordValidation() {
            const testPasswords = [
                { password: '123', valid: false, reason: 'Too short' },
                { password: 'password', valid: false, reason: 'No uppercase/numbers' },
                { password: 'Password', valid: false, reason: 'No numbers' },
                { password: 'Password123', valid: true, reason: 'Valid' },
                { password: 'Test123!', valid: true, reason: 'Valid with special chars' }
            ];
            
            let results = 'Password Validation Test Results:\n\n';
            testPasswords.forEach(test => {
                const isValid = test.password.length >= 8 && 
                               /[A-Z]/.test(test.password) && 
                               /[a-z]/.test(test.password) && 
                               /\d/.test(test.password);
                
                const status = isValid === test.valid ? '✅' : '❌';
                results += `${status} "${test.password}" - ${test.reason}\n`;
            });
            
            showStatus(results, 'info');
        }
        
        function testEmailValidation() {
            const testEmails = [
                { email: 'test@example.com', valid: true },
                { email: 'invalid.email', valid: false },
                { email: '@example.com', valid: false },
                { email: 'test@', valid: false },
                { email: 'test.email@example.co.uk', valid: true },
                { email: '', valid: false }
            ];
            
            let results = 'Email Validation Test Results:\n\n';
            testEmails.forEach(test => {
                const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(test.email);
                const status = isValid === test.valid ? '✅' : '❌';
                results += `${status} "${test.email}"\n`;
            });
            
            showStatus(results, 'info');
        }
        
        // Debug Functions
        async function checkDatabaseHealth() {
            try {
                const data = await apiCall('/api/health');
                showStatus(`✅ Database health check passed\n${JSON.stringify(data, null, 2)}`, 'success');
            } catch (error) {
                showStatus(`❌ Database health check failed: ${error.message}`, 'error');
            }
        }
        
        async function checkKVHealth() {
            // KV health would be tested through session operations
            try {
                if (authToken) {
                    await apiCall('/api/auth/profile');
                    showStatus('✅ KV Store (sessions) appears healthy', 'success');
                } else {
                    showStatus('ℹ️ Login to test KV Store health', 'info');
                }
            } catch (error) {
                showStatus(`❌ KV Store health check failed: ${error.message}`, 'error');
            }
        }
        
        function testEnvironmentVars() {
            const envInfo = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                localStorage: typeof(Storage) !== "undefined",
                apiBase: API_BASE,
                hasToken: !!authToken
            };
            
            document.getElementById('systemStatus').textContent = JSON.stringify(envInfo, null, 2);
            showStatus('✅ Environment information updated', 'success');
        }
        
        function updateSystemStatus() {
            const status = {
                apiConnection: document.getElementById('connectionStatus').textContent,
                jwtToken: authToken ? 'Present' : 'None',
                localStorage: localStorage.length + ' items',
                timestamp: new Date().toISOString()
            };
            
            document.getElementById('systemStatus').textContent = JSON.stringify(status, null, 2);
        }
        
        function startRequestMonitoring() {
            requestMonitoring = true;
            showStatus('✅ Request monitoring started', 'success');
            updateRequestLog();
        }
        
        function stopRequestMonitoring() {
            requestMonitoring = false;
            showStatus('⏹️ Request monitoring stopped', 'info');
        }
        
        function clearRequestLog() {
            requestLog = [];
            performanceMetrics = { requests: 0, totalTime: 0, averageTime: 0, errors: 0 };
            updateRequestLog();
            updatePerformanceMetrics();
            showStatus('🗑️ Request log cleared', 'info');
        }
        
        function updateRequestLog() {
            const logElement = document.getElementById('requestLog');
            if (requestLog.length === 0) {
                logElement.textContent = 'No requests logged yet.';
                return;
            }
            
            const logText = requestLog.slice(-20).map(entry => {
                const status = entry.error ? `ERROR: ${entry.error}` : `${entry.status}`;
                return `${entry.timestamp} | ${entry.method} ${entry.url} | ${status} | ${entry.responseTime}ms`;
            }).join('\n');
            
            logElement.textContent = logText;
        }
        
        function updatePerformanceMetrics() {
            const metrics = {
                totalRequests: performanceMetrics.requests,
                averageResponseTime: performanceMetrics.averageTime + 'ms',
                totalErrors: performanceMetrics.errors,
                errorRate: performanceMetrics.requests > 0 ? 
                    Math.round((performanceMetrics.errors / performanceMetrics.requests) * 100) + '%' : '0%'
            };
            
            document.getElementById('performanceMetrics').textContent = JSON.stringify(metrics, null, 2);
        }
        
        function viewServerLogs() {
            showStatus('ℹ️ Server logs are visible in your terminal where "wrangler dev" is running', 'info');
        }
        
        // GDPR and Data Export
        async function testGDPRCompliance() {
            if (!authToken) {
                showStatus('❌ Please log in to test GDPR compliance', 'error');
                return;
            }
            
            try {
                const profile = await apiCall('/api/auth/profile');
                const gdprStatus = profile.user.gdprConsent ? 'Granted' : 'Not granted';
                showStatus(`✅ GDPR Consent Status: ${gdprStatus}`, 'success');
            } catch (error) {
                showStatus(`❌ GDPR compliance check failed: ${error.message}`, 'error');
            }
        }
        
        async function exportUserData() {
            if (!authToken) {
                showStatus('❌ Please log in to export data', 'error');
                return;
            }
            
            try {
                const [profile, playlists, stats] = await Promise.all([
                    apiCall('/api/auth/profile'),
                    apiCall('/api/playlists'),
                    apiCall('/api/stats')
                ]);
                
                const exportData = {
                    exportDate: new Date().toISOString(),
                    user: profile.user,
                    playlists: playlists.playlists,
                    statistics: stats.stats
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `user-data-export-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showStatus('✅ User data exported successfully', 'success');
                
            } catch (error) {
                showStatus(`❌ Data export failed: ${error.message}`, 'error');
            }
        }
        
        // Comprehensive test runner
        async function runAllTests() {
            showStatus('🧪 Starting comprehensive test suite...', 'info');
            
            const tests = [
                { name: 'Connection Test', fn: testConnection },
                { name: 'Password Validation', fn: testPasswordValidation },
                { name: 'Email Validation', fn: testEmailValidation },
                { name: 'CORS Test', fn: testCORS },
                { name: 'Database Health', fn: checkDatabaseHealth },
                { name: 'All Endpoints', fn: testAllEndpoints }
            ];
            
            for (const test of tests) {
                try {
                    showStatus(`Running: ${test.name}...`, 'info');
                    await test.fn();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    console.error(`Test ${test.name} failed:`, error);
                }
            }
            
            showStatus('✅ Comprehensive test suite completed! Check individual test results above.', 'success');
        }
        
        // Original authentication functions (keeping existing ones)
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const data = await apiCall('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: document.getElementById('regEmail').value,
                        password: document.getElementById('regPassword').value,
                        gdprConsent: document.getElementById('gdprConsent').checked
                    })
                });
                
                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                showStatus('🎉 Registration successful!', 'success');
                document.getElementById('registerForm').reset();
                updateConnectionStatus(true);
                updateJWTDisplay();
                
            } catch (error) {
                showStatus(`❌ Registration failed: ${error.message}`, 'error');
            }
        });
        
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const data = await apiCall('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: document.getElementById('loginEmail').value,
                        password: document.getElementById('loginPassword').value
                    })
                });
                
                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                showStatus('🎉 Login successful!', 'success');
                document.getElementById('loginForm').reset();
                updateConnectionStatus(true);
                updateJWTDisplay();
                
            } catch (error) {
                showStatus(`❌ Login failed: ${error.message}`, 'error');
            }
        });
        
        function logout() {
            authToken = null;
            localStorage.removeItem('authToken');
            showStatus('👋 Logged out successfully', 'success');
            document.getElementById('userInfo').innerHTML = '';
            document.getElementById('playlistList').innerHTML = '';
            updateJWTDisplay();
            if (countdownInterval) clearInterval(countdownInterval);
        }
        
        // Playlists (keeping existing functions)
        document.getElementById('createPlaylistForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!authToken) {
                showStatus('❌ Please log in first', 'error');
                return;
            }
            
            try {
                const data = await apiCall('/api/playlists', {
                    method: 'POST',
                    body: JSON.stringify({
                        title: document.getElementById('playlistTitle').value,
                        originalDescription: document.getElementById('playlistDescription').value,
                        youtubeId: document.getElementById('youtubeId').value || null
                    })
                });
                
                showStatus('🎉 Playlist created successfully!', 'success');
                document.getElementById('createPlaylistForm').reset();
                loadPlaylists();
                
            } catch (error) {
                showStatus(`❌ Failed to create playlist: ${error.message}`, 'error');
            }
        });
        
        async function loadPlaylists() {
            if (!authToken) return;
            
            try {
                const data = await apiCall('/api/playlists');
                const list = document.getElementById('playlistList');
                
                if (data.playlists.length === 0) {
                    list.innerHTML = '<p>📝 No playlists yet. Create your first one!</p>';
                    return;
                }
                
                list.innerHTML = data.playlists.map(playlist => `
                    <div class="playlist-item">
                        <h4>📋 ${playlist.title}</h4>
                        <p>${playlist.originalDescription || 'No description'}</p>
                        <div class="playlist-meta">
                            👁️ Views: ${playlist.views} | 
                            🎥 Videos: ${playlist.videoCount} | 
                            ✨ Enhanced: ${playlist.enhanced ? 'Yes' : 'No'} |
                            📅 Created: ${new Date(playlist.createdAt * 1000).toLocaleDateString()}
                        </div>
                        <button onclick="deletePlaylist('${playlist.id}')" 
                                style="width: auto; background: #dc3545; margin-top: 10px;">
                            🗑️ Delete
                        </button>
                    </div>
                `).join('');
                
            } catch (error) {
                showStatus(`❌ Failed to load playlists: ${error.message}`, 'error');
            }
        }
        
        async function deletePlaylist(id) {
            if (!confirm('🤔 Are you sure you want to delete this playlist?')) return;
            
            try {
                await apiCall(`/api/playlists/${id}`, { method: 'DELETE' });
                showStatus('🗑️ Playlist deleted successfully!', 'success');
                loadPlaylists();
            } catch (error) {
                showStatus(`❌ Failed to delete playlist: ${error.message}`, 'error');
            }
        }
        
        async function deleteAllPlaylists() {
            if (!confirm('⚠️ Are you sure you want to delete ALL playlists? This cannot be undone!')) return;
            
            try {
                const data = await apiCall('/api/playlists');
                for (const playlist of data.playlists) {
                    await apiCall(`/api/playlists/${playlist.id}`, { method: 'DELETE' });
                }
                showStatus('🗑️ All playlists deleted successfully!', 'success');
                loadPlaylists();
            } catch (error) {
                showStatus(`❌ Failed to delete playlists: ${error.message}`, 'error');
            }
        }
        
        // Profile (keeping existing)
        async function loadProfile() {
            if (!authToken) return;
            
            try {
                const [profileData, statsData] = await Promise.all([
                    apiCall('/api/auth/profile'),
                    apiCall('/api/stats')
                ]);
                
                document.getElementById('userInfo').innerHTML = `
                    <div class="user-info">
                        <h3>👤 User Information</h3>
                        <p><strong>📧 Email:</strong> ${profileData.user.email}</p>
                        <p><strong>💳 Subscription:</strong> ${profileData.user.subscriptionTier}</p>
                        <p><strong>📅 Member since:</strong> ${new Date(profileData.user.createdAt * 1000).toLocaleDateString()}</p>
                        <p><strong>🔒 GDPR Consent:</strong> ${profileData.user.gdprConsent ? 'Yes' : 'No'}</p>
                    </div>
                `;
                
                document.getElementById('userStats').innerHTML = `
                    <div class="user-info">
                        <h3>📊 Statistics</h3>
                        <p><strong>📋 Total Playlists:</strong> ${statsData.stats.totalPlaylists}</p>
                        <p><strong>✨ Enhanced Playlists:</strong> ${statsData.stats.enhancedCount}</p>
                        <p><strong>👁️ Total Views:</strong> ${statsData.stats.totalViews}</p>
                        <p><strong>🎥 Total Videos:</strong> ${statsData.stats.totalVideos}</p>
                    </div>
                `;
                
            } catch (error) {
                showStatus(`❌ Failed to load profile: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        if (authToken) {
            showStatus('🔑 Previously logged in session found', 'success');
            updateConnectionStatus(true);
            updateJWTDisplay();
        }
        
        // Test connection on page load
        testConnection();
        
        // Auto-test connection every 30 seconds
        setInterval(testConnection, 30000);
        
        // Update JWT display every 5 seconds
        setInterval(updateJWTDisplay, 5000);
    </script>
</body>
</html>